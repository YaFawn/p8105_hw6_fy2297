---
title: "8105 HW6"
output: github_document
date: '2022-12-3'
---

```{r}
# load libraries
library(tidyverse)
library(rvest)
library(httr)
library(purrr)
library(patchwork)
library(viridis)
library(modelr)
library(mgcv)
```

# Problem 2
```{r}
# import the data 
url = "https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv"
homicide_df = read_csv(url) %>% 
  janitor::clean_names()
```

```{r}
# tidy it according to the requirements
# resolved = 1, unresolved = 0
homicide_df = 
  homicide_df %>% 
  mutate(
    city_state = paste(city, state, sep = ","),
    disposition = ifelse(disposition == "Closed by arrest", 1, 0),
    victim_age = as.numeric(victim_age),
    victim_race = fct(victim_race)
  ) %>% 
  filter(city_state != "Dallas,TX" & city_state != "Phoenix,AZ" & city_state != "Kansas City,MO" & city_state != "Tulsa,AL") %>% 
  filter(victim_race == "White" | victim_race == "Black")
```

```{r}
homicide_summary_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  select(city_state, disposition, victim_age, victim_sex, victim_race)
```

```{r}
# Baltimore,MD
Baltimore_df = 
  homicide_summary_df %>% 
  filter(city_state == "Baltimore,MD") 
  
 
test_Baltimore = 
  glm(disposition ~ victim_age + victim_sex + victim_race, data = Baltimore_df, family = binomial()) %>%
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower_bound = exp(estimate - 1.96 * std.error),
    CI_upper_bound = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, estimate, OR, CI_lower_bound, CI_upper_bound) %>% 
  knitr::kable(digits = 4)
test_Baltimore

```

```{r}
# all other cities' data
cities_stats = 
  homicide_summary_df %>% 
  nest(reg_data = -city_state) %>% 
  mutate(
    reg_line = map(.x = reg_data, ~glm(disposition ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
    reg_line = map(reg_line, broom::tidy)
  ) %>% 
  select(-reg_data) %>% 
  unnest(reg_line) %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(
    OR = exp(estimate),
    CI_lower_bound = exp(estimate - 1.96 * std.error),
    CI_upper_bound = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, OR, CI_lower_bound, CI_upper_bound)

# making a plot
OR_plot =
  cities_stats %>% 
  ggplot(aes(x = fct_reorder(city_state, OR), y = OR)) + geom_point() + geom_errorbar(aes(ymin = CI_lower_bound, ymax = CI_upper_bound)) +
  labs(title = "OR for solving homicides comparing male to female", x = "City/State", y = "OR") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.9, hjust = 1)) +
  theme(plot.title = element_text(hjust = 0.5)) 

OR_plot
```
comment of the OR plot:
New York has the lowest estimated OR and Albuquerque has the highest estimated OR and it also has the widest confidence interval. Some cities like San Bemardino has lower OR than some other cities but it has wider associated confidence interval.

# Problem 3
```{r}
# data manipulation, check for any missing values
birth_df =
  read_csv("birthweight.csv") %>% 
  janitor::clean_names() %>% 
  select(bwt, everything()) %>% 
  drop_na()
```
comment: The size of the birthweight dataset doesn't change before and after dropping the NAs, so there is no missing value in the dataset.

```{r}
# convert numeric to factor where appropriate
birth_df %>% 
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    malform = as.factor(malform),
    mrace = as.factor(mrace),
    parity = as.factor(parity),
    pnumlbw = as.factor(pnumlbw),
    pnumsga = as.factor(pnumsga)
  )
```

```{r}
# model building
birth_model = 
  lm(bwt ~ babysex + momage + ppbmi, data = birth_df) %>% 
  broom::tidy()

birth_model
```

```{r}
# comparison models
compare_models = 
  crossv_mc(birth_df,100) %>% 
  mutate(
    train = map(train,as_tibble),
    test = map(test, as_tibble)
  ) %>% 
  mutate(
    model1 = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    model2 = map(train, ~lm(bwt ~ bhead + blength + babysex, data = .x))
  ) %>% 
  mutate(
    rmse_model1 = map2_dbl(model1, test, ~rmse(model =  .x, data = .y)),
    rmse_model2 = map2_dbl(model2, test, ~rmse(model =  .x, data = .y))
  )
```
modeling process description:










