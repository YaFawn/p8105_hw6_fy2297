8105 HW6
================
2022-12-3

``` r
# load libraries
library(tidyverse)
```

    ## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
    ## ✔ ggplot2 3.4.0      ✔ purrr   0.3.5 
    ## ✔ tibble  3.1.8      ✔ dplyr   1.0.10
    ## ✔ tidyr   1.2.1      ✔ stringr 1.4.1 
    ## ✔ readr   2.1.3      ✔ forcats 0.5.2 
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()

``` r
library(rvest)
```

    ## 
    ## 载入程辑包：'rvest'
    ## 
    ## The following object is masked from 'package:readr':
    ## 
    ##     guess_encoding

``` r
library(httr)
library(purrr)
library(patchwork)
library(viridis)
```

    ## 载入需要的程辑包：viridisLite

``` r
library(modelr)
library(mgcv)
```

    ## 载入需要的程辑包：nlme
    ## 
    ## 载入程辑包：'nlme'
    ## 
    ## The following object is masked from 'package:dplyr':
    ## 
    ##     collapse
    ## 
    ## This is mgcv 1.8-41. For overview type 'help("mgcv-package")'.

# Problem 2

``` r
# import the data 
url = "https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv"
homicide_df = read_csv(url) %>% 
  janitor::clean_names()
```

    ## Rows: 52179 Columns: 12
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
# tidy it according to the requirements
# resolved = 1, unresolved = 0
homicide_df = 
  homicide_df %>% 
  mutate(
    city_state = paste(city, state, sep = ","),
    disposition = ifelse(disposition == "Closed by arrest", 1, 0),
    victim_age = as.numeric(victim_age),
    victim_race = fct(victim_race)
  ) %>% 
  filter(city_state != "Dallas,TX" & city_state != "Phoenix,AZ" & city_state != "Kansas City,MO" & city_state != "Tulsa,AL") %>% 
  filter(victim_race == "White" | victim_race == "Black")
```

    ## Warning in mask$eval_all_mutate(quo): 强制改变过程中产生了NA

``` r
homicide_summary_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  select(city_state, disposition, victim_age, victim_sex, victim_race)
```

``` r
# Baltimore,MD
Baltimore_df = 
  homicide_summary_df %>% 
  filter(city_state == "Baltimore,MD") 
  
 
test_Baltimore = 
  glm(disposition ~ victim_age + victim_sex + victim_race, data = Baltimore_df, family = binomial()) %>%
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower_bound = exp(estimate - 1.96 * std.error),
    CI_upper_bound = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, estimate, OR, CI_lower_bound, CI_upper_bound) %>% 
  knitr::kable(digits = 4)
test_Baltimore
```

| term             | estimate |     OR | CI_lower_bound | CI_upper_bound |
|:-----------------|---------:|-------:|---------------:|---------------:|
| (Intercept)      |   1.1517 | 3.1637 |         1.9892 |         5.0315 |
| victim_age       |  -0.0067 | 0.9933 |         0.9868 |         0.9998 |
| victim_sexMale   |  -0.8545 | 0.4255 |         0.3246 |         0.5579 |
| victim_raceBlack |  -0.8418 | 0.4310 |         0.3060 |         0.6069 |

``` r
# all other cities' data
cities_stats = 
  homicide_summary_df %>% 
  nest(reg_data = -city_state) %>% 
  mutate(
    reg_line = map(.x = reg_data, ~glm(disposition ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
    reg_line = map(reg_line, broom::tidy)
  ) %>% 
  select(-reg_data) %>% 
  unnest(reg_line) %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(
    OR = exp(estimate),
    CI_lower_bound = exp(estimate - 1.96 * std.error),
    CI_upper_bound = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(city_state, OR, CI_lower_bound, CI_upper_bound)

# making a plot
OR_plot =
  cities_stats %>% 
  ggplot(aes(x = fct_reorder(city_state, OR), y = OR)) + geom_point() + geom_errorbar(aes(ymin = CI_lower_bound, ymax = CI_upper_bound)) +
  labs(title = "OR for solving homicides comparing male to female", x = "City/State", y = "OR") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.9, hjust = 1)) +
  theme(plot.title = element_text(hjust = 0.5)) 

OR_plot
```

![](p8105_hw6_fy2297_files/figure-gfm/unnamed-chunk-6-1.png)<!-- -->
comment of the OR plot: New York has the lowest estimated OR and
Albuquerque has the highest estimated OR and it also has the widest
confidence interval. Some cities like San Bemardino has lower OR than
some other cities but it has wider associated confidence interval.

# Problem 3

``` r
# data manipulation
birth_df =
  read_csv("birthweight.csv") %>% 
  janitor::clean_names() %>% 
  select(bwt, everything()) %>% 
  drop_na()
```

    ## Rows: 4342 Columns: 20
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (20): babysex, bhead, blength, bwt, delwt, fincome, frace, gaweeks, malf...
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
# model building
birth_model = 
  lm(bwt ~ babysex + momage + ppbmi, data = birth_df) %>% 
  broom::tidy()

birth_model
```

    ## # A tibble: 4 × 5
    ##   term        estimate std.error statistic   p.value
    ##   <chr>          <dbl>     <dbl>     <dbl>     <dbl>
    ## 1 (Intercept)   2612.      68.1      38.4  2.34e-277
    ## 2 babysex        -83.4     15.3      -5.44 5.51e-  8
    ## 3 momage          16.6      1.98      8.40 5.94e- 17
    ## 4 ppbmi           13.4      2.41      5.55 3.08e-  8

``` r
# comparison models
compare_models = 
  crossv_mc(birth_df,100) %>% 
  mutate(
    train = map(train,as_tibble),
    test = map(test, as_tibble)
  ) %>% 
  mutate(
    model1 = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    model2 = map(train, ~lm(bwt ~ bhead + blength + babysex, data = .x))
  ) %>% 
  mutate(
    rmse_model1 = map2_dbl(model1, test, ~rmse(model =  .x, data = .y)),
    rmse_model2 = map2_dbl(model2, test, ~rmse(model =  .x, data = .y))
  )
```

modeling process description:
